
<?php    
        //Instanciacion del nombre y tipo para las otras operaciones JQuery
        var nombre = (<?php echo json_encode($_SESSION['nomUsuario']); ?>);
        var tipo = (<?php echo json_encode($_SESSION['tipoUsuario']); ?>);
        
        //Cambio del nombre de usuario
        $("#User").text(nombre);    
        
        //Implementacion de la imagen del usuario
        $.post("validar.php",{
            devolverImagen:""
        },
        function(data, status){ 
            $("#imagenUsuario").attr("src",data);
        });

        //Implementacion de las cards dependiendo del tipo de usuario 
        $.post("validar.php",{
            crearCards:""
        },
        function(data, status){ 
            $("#rowCartas").append(data);
        });

    //Devolver imagen de la bdd
    if(isset($_POST['devolverImagen'])){
        $con = conectar();
        $query = "SELECT FOTO_USU FROM usuarios WHERE USU_USU=? and TIPO_USU=?";
        $sentencia = $con -> prepare($query);
        if($sentencia -> execute(array($_SESSION['nomUsuario'], $_SESSION['tipoUsuario']))){
            $r = $sentencia -> fetch();
            header('Content-type: img/png');
            echo ("data:image;base64,".base64_encode($r['FOTO_USU']));
        }else{
            echo("No se encuentra la Imagen");
        }
    }

    //Imprimir cartas de las asignaturas donde esta registrado un ESTUDIANTE o que tiene un DOCENTE
    if(isset($_POST['crearCards'])){

            $con = conectar();
            if($_SESSION['tipoUsuario'] == "ESTUDIANTE"){
                $queryTipo = "SELECT * FROM asignaturas WHERE ID_ASI IN (SELECT ID_ASI_DET FROM detalle_asignaturas
                    WHERE ID_USU_DET IN (SELECT ID_USU FROM usuarios WHERE USU_USU = ? AND TIPO_USU= ?))";
            }elseif($_SESSION['tipoUsuario'] == "DOCENTE"){
                $queryTipo = "SELECT * FROM asignaturas WHERE ID_DOC_ASI = (SELECT ID_USU FROM usuarios WHERE USU_USU = ? AND TIPO_USU= ?)";
            }

            $sentencia = $con -> prepare($queryTipo);
            $sentencia -> execute(array($_SESSION['nomUsuario'], $_SESSION['tipoUsuario']));
            $r = $sentencia->fetchAll();
            $cartas = "";
            foreach($r as $resu){
                $cartas.='<div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    FISEI</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800 Asignatura">'.$resu['NOM_ASI'].'.</div>
                                <p class="titulo">'.$resu['NOM_ASI'].'</p>
                                <a href="#" class="card-link">Ingresar al Curso</a>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-calendar fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>';
            }
            echo($cartas);
        }
?>